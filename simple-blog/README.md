# simple-blog

Cloudflare D1を使って、シンプルなブログアプリのAPIを使ってみる。作成する機能は次の通り。

- ブログアプリにはユーザーがいる
- ユーザーは記事を投稿・更新・削除できる
- ユーザーは記事にタグをつけられる
- ユーザーは記事のタグを更新できる

認証機能は簡単に作る方法が思いつかなかったので、とりあえず作らないことにします。

フロントエンドも作ってみることになったら使ってみようかなと思います。

## 試したいこと

- sqldefでマイグレーションを実行すること
- D1 Client APIでCRUD処理を実行すること

## データベースの作成、マイグレーション

```bash
# ローカルのデータベースの作成
npm run create-local-db

# マイグレーションファイルの作成
npm run migrate:create <message>
DB=/path/to/sqlite/db
sqlite3def --dry-run $DB < schema.sql # マイグレーションファイルにコピーする

# マイグレーションの実行
npm run migrate:apply
```

## メモ

```bash
npm create cloudflare simple-blog
cd simple-blog

wrangler d1 create blog
```

データベースを作成できたので、まずはsqldefでマイグレーションをしてみる。sqldef + D1のサンプルがあるので、それを参考にさせていただく。

https://github.com/chimame/remix-kysely-d1

ローカルで開発しているときに、どのタイミングでデータベースが作成されるのかを知りたい。→ローカルのd1にクエリを実行するコマンドを実行すると、作成されました。

sqldefとD1のマイグレーションを組み合わせる部分は試行錯誤中。ローカルのDBのパスをどうやって指定するかなどが問題。

- d1のコマンドでマイグレーションを作成（ファイル名は、`0000_<入力したマイグレーション名>`のような感じ）
- sqldefの--dry-runで差分を出力し、上記で作成したファイルに書き込む（ここで失敗するとファイルが残るので、最初にやったほうがいいかも）
- マイグレーションをローカルのDBに対して適用する

というのを`npm run migrate:dev`とかでできたら便利かなと思いました。あとは、`npm run migrate:create`（マイグレーションファイルを作るだけ）もあれば便利かなと思います。

これには、d1のデータベース名と、ローカルのデータベースのファイルのパスが必要です。環境変数などに設定すればできますが、面倒です。`wrangler.toml`の情報があればどちらも計算できるので、設定ファイルの情報をコマンドから取得できればできそうです。

追記: 次のnpmスクリプトを作りました。変化がない場合はスキップできるようにしたいのと、`d1_migrations`テーブルは無視するようにしたいです。

```bash
npm run migrate:create # マイグレーションファイルを作成する
npm run migrate:dev # マイグレーションファイルを作成して、適用する
npm run migrate:apply # マイグレーションを適用する
npm run migrate:apply:production # 本番のDBにマイグレーションを適用する
```

## 記事の登録・更新・削除機能の作成

とりあえずユーザーは固定ということにします。まず、ルーティングライブラリが欲しいのでHonoをインストールして使います。
